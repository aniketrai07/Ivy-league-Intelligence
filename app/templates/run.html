{% extends "base.html" %}
{% block content %}

<div class="rounded-2xl glass p-6">
  <h1 class="text-2xl font-semibold">Running Scraper</h1>
  <p class="muted text-sm mt-2" id="subtitle">
    Please wait… this can take some seconds depending on websites.
  </p>

  <div class="mt-6 flex items-center gap-3">
    <div class="h-5 w-5 rounded-full border-2 border-white/20 border-t-white/80 animate-spin"></div>
    <div class="text-sm muted" id="statusText">Starting…</div>
  </div>

  <div class="mt-6 rounded-2xl border border-white/10 bg-slate-950/40 p-4 hidden" id="resultBox">
    <div class="text-sm font-semibold">Result</div>
    <pre class="mt-3 text-sm whitespace-pre-wrap muted" id="resultPre"></pre>
  </div>

  <div class="mt-6 flex gap-3">
    <a href="/" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm">
      Back to Dashboard
    </a>
    <button id="backBtn" class="px-4 py-2 rounded-xl bg-indigo-600/90 hover:bg-indigo-600 border border-indigo-400/20 text-sm hidden">
      Go back & refresh
    </button>
  </div>
</div>

<script>
  const statusText = document.getElementById("statusText");
  const resultBox = document.getElementById("resultBox");
  const resultPre = document.getElementById("resultPre");
  const backBtn = document.getElementById("backBtn");
  const subtitle = document.getElementById("subtitle");

  const params = new URLSearchParams(window.location.search);
  const uni = params.get("uni");
  const prev = document.referrer || (uni ? ("/university/" + encodeURIComponent(uni)) : "/");

  async function run() {
    try {
      if (uni) subtitle.textContent = `Running scraper only for: ${uni} (fast mode)`;
      statusText.textContent = "Scraping pages…";

      const url = uni ? ("/run-university/" + encodeURIComponent(uni)) : "/run-json";
      const res = await fetch(url);
      const data = await res.json();

      statusText.textContent = "Done ✅";
      resultBox.classList.remove("hidden");
      resultPre.textContent = JSON.stringify(data, null, 2);

      backBtn.classList.remove("hidden");
      backBtn.onclick = () => window.location.href = prev;
    } catch (e) {
      statusText.textContent = "Failed ❌ (check server console)";
      resultBox.classList.remove("hidden");
      resultPre.textContent = String(e);

      backBtn.classList.remove("hidden");
      backBtn.onclick = () => window.location.href = prev;
    }
  }

  run();
</script>

{% endblock %}